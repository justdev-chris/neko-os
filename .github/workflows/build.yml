name: Build NekoOS
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          qemu-system \
          nasm \
          gcc \
          gcc-multilib \
          make \
          grub-pc-bin \
          grub-common \
          xorriso \
          mtools
    
    - name: Create missing files
      run: |
        # Create directories
        mkdir -p src/boot src/kernel scripts
        
        # Create linker.ld if missing
        if [ ! -f linker.ld ]; then
          cat > linker.ld << 'EOF'
OUTPUT_FORMAT(elf32-i386)
ENTRY(kernel_main)

SECTIONS {
  . = 1M;
  
  .multiboot : {
    *(.multiboot)
  }
  
  .text : ALIGN(4K) {
    *(.text)
  }
  
  .rodata : ALIGN(4K) {
    *(.rodata)
  }
  
  .data : ALIGN(4K) {
    *(.data)
  }
  
  .bss : ALIGN(4K) {
    *(COMMON)
    *(.bss)
  }
}
EOF
        fi
        
        # Create make-iso.sh if missing
        if [ ! -f scripts/make-iso.sh ]; then
          cat > scripts/make-iso.sh << 'EOF'
#!/bin/bash
set -e

mkdir -p isodir/boot/grub
cp build/kernel.bin isodir/boot/nekoos.bin

cat > isodir/boot/grub/grub.cfg << 'GRUBEOF'
set timeout=3
set default=0

menuentry "NekoOS" {
  multiboot /boot/nekoos.bin
  boot
}
GRUBEOF

grub-mkrescue -o nekoos.iso isodir 2>/dev/null || \
  xorriso -as mkisofs -R -b boot/grub/i386-pc/eltorito.img \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
    -o nekoos.iso isodir

echo "ISO created"
EOF
          chmod +x scripts/make-iso.sh
        fi
        
        # Create src/boot/multiboot.asm if missing
        if [ ! -f src/boot/multiboot.asm ]; then
          cat > src/boot/multiboot.asm << 'EOF'
section .multiboot
align 4

multiboot_header:
  dd 0x1BADB002
  dd 0x00000003
  dd -(0x1BADB002 + 0x00000003)
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
  dd 0x00000000
EOF
        fi
        
        # Create kernel files if missing
        if [ ! -f src/kernel/main.c ]; then
          cat > src/kernel/main.c << 'EOF'
#include <stdint.h>

volatile uint16_t* vga_buffer = (uint16_t*)0xB8000;

void kernel_main(void) {
  // Clear screen
  for (int i = 0; i < 80*25; i++) {
    vga_buffer[i] = (0x0F << 8) | ' ';
  }
  
  // Print message
  const char* msg = "NekoOS loaded successfully!";
  for (int i = 0; msg[i]; i++) {
    vga_buffer[i] = (0x0A << 8) | msg[i];
  }
  
  while(1) asm("hlt");
}
EOF
        fi
        
        if [ ! -f src/kernel/multiboot.c ]; then
          cat > src/kernel/multiboot.c << 'EOF'
void parse_multiboot_tags(unsigned int addr) {
  (void)addr;
}
EOF
        fi
        
        if [ ! -f src/kernel/vga.c ]; then
          cat > src/kernel/vga.c << 'EOF'
// VGA utilities placeholder
EOF
        fi
    
    - name: Build
      run: |
        make clean
        make all
    
    - name: Test
      run: |
        timeout --foreground 5s make run || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nekoos-build
        path: |
          build/kernel.bin
          nekoos.iso
        retention-days: 7
