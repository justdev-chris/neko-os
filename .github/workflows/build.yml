name: Build NekoOS
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-system \
          nasm \
          gcc \
          gcc-multilib \
          make \
          grub-pc-bin \
          grub-common \
          grub2-common \
          xorriso \
          mtools
    
    - name: Create linker script
      run: |
        cat > linker.ld << 'EOF'
        OUTPUT_FORMAT(elf32-i386)
        ENTRY(kernel_main)
        
        SECTIONS {
          . = 1M;
          
          .multiboot : {
            *(.multiboot)
          }
          
          .text : ALIGN(4K) {
            *(.text)
          }
          
          .rodata : ALIGN(4K) {
            *(.rodata)
          }
          
          .data : ALIGN(4K) {
            *(.data)
          }
          
          .bss : ALIGN(4K) {
            *(COMMON)
            *(.bss)
          }
        }
        EOF
    
    - name: Fix Makefile
      run: |
        # Remove duplicate -m32 flags if any
        sed -i 's/-m32 -m32/-m32/g' Makefile
    
    - name: Fix ISO script
      run: |
        # Update path in make-iso.sh
        sed -i 's|kernel/kernel.bin|build/kernel.bin|g' scripts/make-iso.sh
    
    - name: Build
      run: |
        make clean
        make all
    
    - name: Build ISO
      run: make iso
    
    - name: Test in QEMU
      run: |
        timeout --foreground 10s make run || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nekoos-build
        path: |
          build/kernel.bin
          nekoos.iso
        retention-days: 7
